<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Donaciones</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .donaciones-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
    .donacion-form { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; }
    .form-row { display: flex; gap: 15px; margin: 10px 0; }
    .form-row input, .form-row select, .form-row textarea { flex: 1; padding: 8px; }
    .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .donaciones-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .donaciones-table th, .donaciones-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    .donaciones-table th { background: #f2f2f2; }
    .monto-alto { background-color: #e8f5e8; }
    .stats { display: flex; gap: 20px; margin: 20px 0; }
    .stat-card { background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; flex: 1; }
  </style>
</head>
<body>
  <div class="donaciones-container">
    <h2>Gestión de Donaciones</h2>
    
    <div class="donacion-form">
      <h3>Registrar Nueva Donación</h3>
      <form id="donacionForm">
        <div class="form-row">
          <select id="tipo_donacion" required>
            <option value="">Tipo de donación</option>
            <option value="Dinero">Dinero</option>
            <option value="Alimento">Alimento</option>
            <option value="Medicamento">Medicamento</option>
            <option value="Otro">Otro</option>
          </select>
          <input type="number" id="monto" placeholder="Monto" min="0" step="0.01" required>
        </div>
        <div class="form-row">
          <textarea id="descripcion" placeholder="Descripción de la donación"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Registrar Donación</button>
      </form>
    </div>

    <!-- Estadísticas -->
    <div class="stats">
      <div class="stat-card">
        <h4>Total Donaciones</h4>
        <p id="total-donaciones">0</p>
      </div>
      <div class="stat-card">
        <h4>Monto Total</h4>
        <p id="monto-total">$0</p>
      </div>
      <div class="stat-card">
        <h4>Este Mes</h4>
        <p id="donaciones-mes">0</p>
      </div>
    </div>

    <!-- Filtros -->
    <div class="donacion-form">
      <h3>Filtros</h3>
      <div class="form-row">
        <select id="filtro-tipo" onchange="cargarDonaciones()">
          <option value="">Todos los tipos</option>
          <option value="Dinero">Dinero</option>
          <option value="Alimento">Alimento</option>
          <option value="Medicamento">Medicamento</option>
          <option value="Otro">Otro</option>
        </select>

        <button onclick="cargarDonaciones()" class="btn btn-primary">Actualizar</button>
      </div>
    </div>

    <!-- Tabla de donaciones -->
    <table class="donaciones-table">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Monto</th>
          <th>Fecha</th>
          <th>Descripción</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="donaciones-tbody">
      </tbody>
    </table>
    
    <p id="mensaje"></p>
    <button onclick="location.href='loggedpageemp.html'" class="btn">Volver al Menú</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', cargarDonaciones);

    document.getElementById('donacionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const tipoElement = document.getElementById('tipo_donacion');
      const montoElement = document.getElementById('monto');
      const descripcionElement = document.getElementById('descripcion');
      
      if (!tipoElement || !montoElement || !descripcionElement) {
        document.getElementById('mensaje').textContent = 'Error: Elementos del formulario no encontrados';
        return;
      }
      
      const donacionData = {
        tipo_donacion: tipoElement.value,
        monto: montoElement.value || 0,
        descripcion: descripcionElement.value
      };

      try {
        const res = await fetch('http://3.141.131.90:5000/api/donaciones', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(donacionData)
        });

        if (res.ok) {
          document.getElementById('mensaje').textContent = 'Donación registrada exitosamente';
          document.getElementById('donacionForm').reset();
          cargarDonaciones();
        } else {
          const error = await res.json();
          document.getElementById('mensaje').textContent = error.mensaje || 'Error al registrar donación';
        }
      } catch (error) {
        document.getElementById('mensaje').textContent = 'Error de conexión';
      }
    });

    async function cargarDonaciones() {
      try {
        console.log('Cargando donaciones...');
        const res = await fetch('http://3.141.131.90:5000/api/donaciones');
        
        if (!res.ok) {
          const errorData = await res.json();
          console.error('Error del servidor:', errorData);
          document.getElementById('mensaje').textContent = 'Error: ' + (errorData.mensaje || 'Error desconocido');
          return;
        }
        
        const donaciones = await res.json();
        console.log('Donaciones recibidas:', donaciones);
        
        // Aplicar filtros
        const filtroTipo = document.getElementById('filtro-tipo')?.value || '';
        
        let donacionesFiltradas = donaciones;
        
        if (filtroTipo) {
          donacionesFiltradas = donacionesFiltradas.filter(d => d.tipo_donacion === filtroTipo);
        }
        


        // Actualizar estadísticas
        actualizarEstadisticas(donaciones);

        const tbody = document.getElementById('donaciones-tbody');
        tbody.innerHTML = '';

        donacionesFiltradas.forEach(donacion => {
          const row = document.createElement('tr');
          
          // Resaltar montos altos
          if (donacion.monto && parseFloat(donacion.monto) >= 1000) {
            row.className = 'monto-alto';
          }
          
          const monto = donacion.monto ? parseFloat(donacion.monto).toFixed(2) : '0.00';
          const fecha = donacion.fecha_donado ? new Date(donacion.fecha_donado).toLocaleDateString() : 'N/A';
          
          row.innerHTML = `
            <td>${donacion.tipo_donacion || 'N/A'}</td>
            <td>$${monto}</td>
            <td>${fecha}</td>
            <td>${donacion.descripcion || 'N/A'}</td>
            <td>
              <button onclick="eliminarDonacion(${donacion.id_donacion})" class="btn btn-danger">
                Eliminar
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error de conexión:', error);
        document.getElementById('mensaje').textContent = 'Error de conexión: ' + error.message;
      }
    }

    function actualizarEstadisticas(donaciones) {
      const totalDonaciones = donaciones.length;
      const montoTotal = donaciones.reduce((sum, d) => sum + (parseFloat(d.monto) || 0), 0);
      
      const fechaActual = new Date();
      const donacionesMes = donaciones.filter(d => {
        const fechaDonacion = new Date(d.fecha_donado);
        return fechaDonacion.getMonth() === fechaActual.getMonth() && 
               fechaDonacion.getFullYear() === fechaActual.getFullYear();
      }).length;

      document.getElementById('total-donaciones').textContent = totalDonaciones;
      document.getElementById('monto-total').textContent = '$' + montoTotal.toFixed(2);
      document.getElementById('donaciones-mes').textContent = donacionesMes;
    }

    async function eliminarDonacion(id) {
      if (confirm('¿Estás seguro de eliminar esta donación?')) {
        try {
          const res = await fetch(`http://3.141.131.90:5000/api/donaciones/${id}`, {
            method: 'DELETE'
          });

          if (res.ok) {
            document.getElementById('mensaje').textContent = 'Donación eliminada correctamente';
            cargarDonaciones();
          } else {
            document.getElementById('mensaje').textContent = 'Error al eliminar donación';
          }
        } catch (error) {
          document.getElementById('mensaje').textContent = 'Error de conexión';
        }
      }
    }
  </script>
</body>
</html>