<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador de Usuarios</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="admin-container">
    <h2>Administrador de Usuarios</h2>
    <div id="usuarios-list"></div>
    <h3>Agregar Usuario</h3>
    <form id="addUserForm">
      <input type="text" id="newUsername" placeholder="Usuario" required>
      <input type="password" id="newPassword" placeholder="Contraseña" required>
      <select id="newRole" required>
        <option value="">Rol</option>
        <option value="admin">Administrador</option>
        <option value="empleado">Empleado</option>
        <option value="veterinario">Veterinario</option>
      </select>
      <button type="submit">Agregar Usuario</button>
    </form>
    <p id="mensaje"></p>
  </div>
  <script>
    // Solo permite acceso si el usuario logueado es Admin
    const usuario = JSON.parse(localStorage.getItem('usuarioLogueado'));
    if (!usuario || (usuario.role !== 'admin' && usuario.role !== 'Admin')) {
      document.body.innerHTML = '<h2>Acceso denegado - Solo administradores</h2><p>Necesitas permisos de administrador para acceder a esta sección.</p>';
    } else {
      async function fetchUsuarios() {
        try {
          const res = await fetch('http://3.141.131.90:5000/api/usuarios');
          if (!res.ok) throw new Error('Error del servidor');
          return await res.json();
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('mensaje').textContent = 'Error: Asegúrate de que el backend esté corriendo';
          return [];
        }
      }

      async function renderUsuarios() {
        const usuarios = await fetchUsuarios();
        const list = document.getElementById('usuarios-list');
        list.innerHTML = '<h3>Usuarios Registrados</h3>';
        usuarios.forEach(u => {
          list.innerHTML += `
            <div style="margin-bottom:8px; padding:10px; border:1px solid #ddd; border-radius:5px;">
              <strong>${u.username}</strong> (${u.role})
              <button onclick="eliminarUsuario(${u.id})" style="margin-left:10px; background:#f44336; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Eliminar</button>
            </div>
          `;
        });
      }

      window.eliminarUsuario = async function(id) {
        if (confirm('¿Estás seguro de eliminar este usuario?')) {
          try {
            await fetch(`http://3.141.131.90:5000/api/usuarios/${id}`, { method: 'DELETE' });
            document.getElementById('mensaje').textContent = 'Usuario eliminado correctamente.';
            renderUsuarios();
          } catch (error) {
            document.getElementById('mensaje').textContent = 'Error al eliminar usuario.';
          }
        }
      };

      document.getElementById('addUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value.trim();
        const role = document.getElementById('newRole').value;

        if (!username || !password || !role) {
          document.getElementById('mensaje').textContent = 'Completa todos los campos.';
          return;
        }

        try {
          const res = await fetch('http://3.141.131.90:5000/api/usuarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role })
          });

          if (res.ok) {
            document.getElementById('mensaje').textContent = 'Usuario agregado correctamente.';
            document.getElementById('addUserForm').reset();
            renderUsuarios();
          } else {
            const data = await res.json();
            document.getElementById('mensaje').textContent = data.message || 'Error al agregar usuario.';
          }
        } catch (error) {
          document.getElementById('mensaje').textContent = 'Error de conexión.';
        }
      });

      // Inicializa la lista al cargar
      renderUsuarios();
    }
  </script>
</body>
</html>